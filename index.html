<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Fly Bird — Full (backgroud.html)</title>

  <!-- ============================
       STYLE: panjang & terpisah
       ============================ -->
  <style>
    :root{
      --ui-bg: rgba(255,255,255,0.96);
      --accent: #ff8c00;
      --muted: #666;
      --hud-shadow: 0 3px 8px rgba(0,0,0,0.35);
    }

    html,body{
      height:100%;
      margin:0;
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      background: linear-gradient(#87CEEB,#bfefff);
      -webkit-tap-highlight-color: transparent;
    }

    /* Container untuk center canvas dan overlay */
    #container{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
    }

    /* Canvas */
    canvas{
      display:block;
      max-width:100%;
      height:auto;
      touch-action:none; /* prevent scrolling when tapping */
      border-radius:10px;
      box-shadow:0 8px 30px rgba(0,0,0,0.25);
      background-color: transparent;
      background-size: cover;
      background-position: center;
    }

    /* Responsive ratio choices */
    @media (min-aspect-ratio: 2/3) {
      /* wide screens: set canvas to classic Flappy size */
      canvas{ width:420px; height:630px; }
    }
    @media (max-aspect-ratio: 2/3) {
      /* tall screens (phones): use full width minus margin */
      canvas{ width:calc(100vw - 20px); height:calc(100vh - 80px); }
    }

    /* Top HUD (Score + buttons) */
    #topUI{
      position:absolute;
      top:12px;
      left:12px;
      z-index:40;
      color:#fff;
      font-weight:700;
      text-shadow:0 2px 4px rgba(0,0,0,0.5);
      display:flex;
      gap:8px;
      align-items:center;
      pointer-events:none; /* allow clicks to pass to canvas except buttons inside */
    }
    /* Buttons inside topUI need pointer events */
    #topUI .btn{ pointer-events:auto; }

    .hudBox{
      background:rgba(0,0,0,0.35);
      padding:6px 10px;
      border-radius:10px;
      color:white;
      font-weight:700;
      font-size:16px;
      box-shadow:var(--hud-shadow);
    }

    /* Mute & Menu buttons */
    .controlBtn{
      position:absolute;
      top:12px;
      right:12px;
      z-index:40;
      display:flex;
      gap:8px;
    }
    .controlBtn button{
      background:rgba(0,0,0,0.35);
      border:0;
      color:#fff;
      padding:8px 10px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
    }

    /* Panel (menu / overlay) */
    .panel{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      background:var(--ui-bg);
      padding:18px;
      border-radius:12px;
      box-shadow:0 6px 18px rgba(0,0,0,0.18);
      width:360px;
      max-width:92%;
      text-align:center;
      z-index:60;
    }
    .panel.hidden{ display:none; }
    .panel h1{ margin:6px 0 10px; font-size:22px; }
    .panel p.desc{ color:var(--muted); margin:6px 0 12px; font-size:14px; }

    .row{ display:flex; gap:8px; justify-content:center; margin-top:10px; flex-wrap:wrap; }
    button.primary{
      background:var(--accent);
      border:none;
      color:white;
      padding:10px 14px;
      border-radius:8px;
      font-weight:700;
      cursor:pointer;
      box-shadow:0 4px 0 rgba(0,0,0,0.08) inset;
    }
    button.secondary{
      background:#ddd;
      border:none;
      padding:8px 12px;
      border-radius:8px;
      cursor:pointer;
      font-weight:700;
    }
    .small{ padding:8px 10px; font-size:14px; }

    .mutedTxt{ color:#444; font-size:13px; margin-top:8px; }

    /* hint bottom */
    #hint{
      position:absolute;
      bottom:14px;
      left:50%;
      transform:translateX(-50%);
      color:#fff;
      text-shadow:0 2px 6px rgba(0,0,0,0.4);
      font-size:13px;
      z-index:50;
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- CANVAS -->
    <canvas id="gameCanvas" width="420" height="630" aria-label="Fly Bird game"></canvas>

    <!-- Top UI (score) -->
    <div id="topUI" aria-hidden="true" style="pointer-events:none">
      <div class="hudBox" id="scoreDisplay">Score: 0</div>
    </div>

    <!-- Top right controls -->
    <div class="controlBtn" style="pointer-events:auto">
      <button id="muteBtn" title="Mute (M)">Mute</button>
      <button id="menuBtn" title="Menu">Menu</button>
    </div>

    <!-- MAIN MENU PANEL -->
    <div id="menuPanel" class="panel" role="dialog" aria-modal="true">
      <h1>Fly Bird</h1>
      <p class="desc">Tap / Klik / Spasi untuk lompat. Hindari pipa.<br>Ganti gambar: <code>bg.png</code> &amp; <code>bird.png</code></p>

      <div style="text-align:left; margin-top:8px;">
        <label style="font-weight:700">Pilih Level</label>
        <div class="row" style="margin-top:8px;">
          <button id="lvlEasy" class="secondary">Easy</button>
          <button id="lvlMed" class="secondary">Medium</button>
          <button id="lvlHard" class="secondary">Hard</button>
        </div>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="playBtn" class="primary">Play</button>
        <button id="howBtn" class="secondary">How</button>
        <button id="resetBest" class="secondary">Reset Best</button>
      </div>

      <div class="mutedTxt" style="text-align:left; margin-top:10px;">
        <div id="bestTxt">Best: 0</div>
        <div style="font-size:12px; margin-top:6px;">(Letakkan file <code>bg.png</code>, <code>bird.png</code>, dan opsional MP3 di folder yang sama)</div>
      </div>
    </div>

    <!-- OVERLAY PANEL (PAUSE / GAME OVER) -->
    <div id="overlayPanel" class="panel hidden" role="dialog" aria-modal="true">
      <h2 id="overlayTitle">Paused</h2>
      <div id="overlayScore" style="font-size:18px; margin:8px 0">Score: 0</div>
      <div class="row">
        <button id="resumeBtn" class="primary">Resume</button>
        <button id="restartBtn" class="secondary">Restart</button>
        <button id="backMenu" class="secondary">Menu</button>
      </div>
      <div style="margin-top:10px; font-size:13px; color:#333">Tip: tekan Spasi / ketuk untuk lompat</div>
    </div>

    <div id="hint">Tap anywhere to flap — press Space on keyboard</div>
  </div>

  <!-- AUDIO ELEMENTS -->
  <!-- NOTE: file names below can be replaced with your filenames.
       Browser may block autoplay until user interacts — code handles that. -->
  <audio id="bgm" src="bgm.mp3" loop preload="auto"></audio>
  <audio id="sndFlap" src="flap.mp3" preload="auto"></audio>
  <audio id="sndPoint" src="point.mp3" preload="auto"></audio>
  <audio id="sndHit" src="hit.mp3" preload="auto"></audio>

  <!-- ============================
       JAVASCRIPT: panjang & terperinci
       ============================ -->
  <script>
  /*
    backgroud.html — Full Fly Bird game (long form)
    - Uses bg.png and bird.png from same folder (user-provided)
    - Draws pipes & ground procedurally (no pipe image required)
    - Menu, levels, sounds, best score (localStorage), pause/resume, restart
    - Mobile + Desktop input (touch, mouse, keyboard)
  */

  (function(){
    // ---- Elements & Canvas ----
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    const menuPanel = document.getElementById('menuPanel');
    const overlayPanel = document.getElementById('overlayPanel');
    const overlayTitle = document.getElementById('overlayTitle');
    const overlayScore = document.getElementById('overlayScore');
    const scoreDisplay = document.getElementById('scoreDisplay');
    const bestTxt = document.getElementById('bestTxt');

    const muteBtn = document.getElementById('muteBtn');
    const menuBtn = document.getElementById('menuBtn');
    const playBtn = document.getElementById('playBtn');
    const resumeBtn = document.getElementById('resumeBtn');
    const restartBtn = document.getElementById('restartBtn');
    const backMenuBtn = document.getElementById('backMenu');
    const howBtn = document.getElementById('howBtn');
    const resetBestBtn = document.getElementById('resetBest');

    const lvlEasy = document.getElementById('lvlEasy');
    const lvlMed = document.getElementById('lvlMed');
    const lvlHard = document.getElementById('lvlHard');

    // Audio elements
    const bgm = document.getElementById('bgm');
    const sndFlap = document.getElementById('sndFlap');
    const sndPoint = document.getElementById('sndPoint');
    const sndHit = document.getElementById('sndHit');

    // Images (user-supplied)
    const bgImg = new Image();
    const birdImg = new Image();
    bgImg.src = 'bg.png';
    birdImg.src = 'bird.png';

    // ---- Game variables ----
    let W = canvas.width, H = canvas.height;
    let gameState = 'menu'; // menu | running | paused | over
    let level = 'easy';     // easy | med | hard
    let muted = false;

    let pipes = [];         // each: {x, top}
    let score = 0;
    let best = 0;

    // Bird object (with sensible defaults)
    const bird = {
      x: 70,
      y: 200,
      w: 48,
      h: 36,
      vy: 0,
      gravity: 0.5,
      flapPower: -8,
      rotation: 0
    };

    // Pipe & ground parameters (will be customized per level)
    let pipeW = 64;
    let gap = 150;
    let pipeSpeed = 2.0;
    let spawnInterval = 110; // in frames
    let spawnTimer = 0;
    let groundH = 80;

    // ---- Utilities ----
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    // ---- Persistence: best score ----
    try{
      best = Number(localStorage.getItem('flybird_best') || 0);
    }catch(e){ best = 0; }
    bestTxt.textContent = `Best: ${best}`;

    // ---- Responsive: fit canvas size (internal coords) ----
    function fitCanvas(){
      // keep internal canvas size in range (so UI scaled consistently)
      W = canvas.width = Math.max(320, Math.min(window.innerWidth - 20, 420));
      H = canvas.height = Math.max(480, Math.min(window.innerHeight - 40, 800));
      // recalc bird pos
      bird.x = Math.round(W * 0.12);
      if (bird.y > H - groundH - bird.h) bird.y = Math.round(H*0.4);
    }
    window.addEventListener('resize', fitCanvas);
    fitCanvas();

    // ---- Level settings ----
    function applyLevelSettings(lv){
      level = lv;
      // Visual feedback on selected button
      [lvlEasy, lvlMed, lvlHard].forEach(btn => btn.style.opacity = '0.7');
      if(lv === 'easy'){ pipeSpeed = 2; gap = 170; spawnInterval = 120; lvlEasy.style.opacity = '1'; }
      if(lv === 'med'){  pipeSpeed = 3; gap = 150; spawnInterval = 100; lvlMed.style.opacity = '1'; }
      if(lv === 'hard'){ pipeSpeed = 4.2; gap = 130; spawnInterval = 85; lvlHard.style.opacity = '1'; }
    }
    applyLevelSettings('easy');

    // expose function to inline onclicks (not strictly necessary)
    window.setLevel = applyLevelSettings;

    // ---- Menu & UI interactions ----
    playBtn.addEventListener('click', startFromMenu);
    menuBtn.addEventListener('click', () => {
      if (gameState === 'running'){
        pauseGame();
      } else {
        menuPanel.style.display = 'block';
      }
    });
    resumeBtn.addEventListener('click', resumeGame);
    restartBtn.addEventListener('click', () => startGame());
    backMenuBtn.addEventListener('click', backToMenu);

    howBtn.addEventListener('click', () => {
      alert('Cara main:\n- Ketuk layar / klik / tekan Spasi untuk lompat.\n- Hindari pipa. Pilih level sebelum Play. Ganti bg.png & bird.png di folder yang sama.');
    });

    resetBestBtn.addEventListener('click', () => {
      if(confirm('Reset best score?')) {
        best = 0;
        try{ localStorage.setItem('flybird_best','0'); }catch(e){}
        bestTxt.textContent = `Best: ${best}`;
      }
    });

    // mute toggle
    muteBtn.addEventListener('click', () => {
      muted = !muted;
      [bgm, sndFlap, sndPoint, sndHit].forEach(a => { try{ a.muted = muted; }catch(e){} });
      muteBtn.textContent = muted ? 'Unmute' : 'Mute';
    });

    // ---- Input handling (touch, mouse, keyboard) ----
    function handleFlap(){
      if (gameState === 'menu') { startFromMenu(); return; }
      if (gameState === 'running'){
        bird.vy = bird.flapPower;
        bird.rotation = -0.7;
        playSound(sndFlap);
      } else if (gameState === 'over') {
        // quick restart when tapping after game over
        startGame();
      }
    }
    canvas.addEventListener('touchstart', function(e){ e.preventDefault(); handleFlap(); }, {passive:false});
    canvas.addEventListener('mousedown', function(){ handleFlap(); });
    window.addEventListener('keydown', function(e){
      if (e.code === 'Space'){ e.preventDefault(); handleFlap(); }
      if (e.code === 'KeyM'){ muteBtn.click(); }
      if (e.code === 'KeyP'){
        if (gameState === 'running') pauseGame();
        else if (gameState === 'paused') resumeGame();
      }
    });

    // unlock audio on first gesture (some browsers block autoplay)
    function unlockAudio(){
      try{
        bgm.volume = 0.45;
        sndFlap.volume = 0.9;
        sndPoint.volume = 0.9;
        sndHit.volume = 0.9;
        bgm.play().then(()=>{ bgm.pause(); }).catch(()=>{});
      }catch(e){}
      window.removeEventListener('touchstart', unlockAudio);
      window.removeEventListener('mousedown', unlockAudio);
    }
    window.addEventListener('touchstart', unlockAudio, {once:true});
    window.addEventListener('mousedown', unlockAudio, {once:true});

    // sound-safe play helper
    function playSound(audio){
      if(!audio) return;
      if(muted) return;
      try{
        audio.currentTime = 0;
        audio.play().catch(()=>{ /* ignore */ });
      }catch(e){}
    }

    // ---- Game flow functions ----
    function startFromMenu(){
      menuPanel.style.display = 'none';
      startGame();
    }

    function startGame(){
      // reset
      fitCanvas();
      pipes = [];
      score = 0;
      spawnTimer = 0;
      bird.y = Math.round(H*0.4);
      bird.vy = 0;
      bird.rotation = 0;
      gameState = 'running';
      // start bgm (if available)
      bgm.currentTime = 0;
      playSound(bgm);
      // start loop
      requestAnimationFrame(loop);
    }

    function pauseGame(){
      if (gameState !== 'running') return;
      gameState = 'paused';
      overlayTitle.textContent = 'Paused';
      overlayScore.textContent = `Score: ${score}`;
      overlayPanel.classList.remove('hidden');
    }

    function resumeGame(){
      if (gameState !== 'paused') return;
      overlayPanel.classList.add('hidden');
      gameState = 'running';
      requestAnimationFrame(loop);
    }

    function backToMenu(){
      // stop & show menu
      gameState = 'menu';
      overlayPanel.classList.add('hidden');
      menuPanel.style.display = 'block';
      bgm.pause();
    }

    // ---- Spawn pipe ----
    function spawnPipe(){
      const minTop = 40;
      // top max: leave space for ground & gap
      const maxTop = Math.max(90, H - groundH - gap - 40);
      const top = Math.floor(Math.random() * (maxTop - minTop)) + minTop;
      pipes.push({ x: W + 20, top: top, passed: false });
    }

    // ---- Collision check: axis-aligned boxes ----
    function checkCollision(pipe){
      const bx1 = bird.x, by1 = bird.y, bx2 = bird.x + bird.w, by2 = bird.y + bird.h;
      const px1 = pipe.x, py1 = 0, px2 = pipe.x + pipeW, py2 = pipe.top;
      const bxTop = pipe.top + gap;
      const p2x1 = pipe.x, p2y1 = bxTop, p2x2 = pipe.x + pipeW, p2y2 = H - groundH;

      // overlap with top pipe?
      const overlapTop = !(bx2 < px1 || bx1 > px2 || by2 < py1 || by1 > py2);
      const overlapBottom = !(bx2 < p2x1 || bx1 > p2x2 || by2 < p2y1 || by1 > p2y2);
      return overlapTop || overlapBottom;
    }

    // ---- When hit ----
    function hit(){
      gameState = 'over';
      playSound(sndHit);
      try{ bgm.pause(); }catch(e){}
      // save best
      if (score > best){
        best = score;
        try{ localStorage.setItem('flybird_best', String(best)); }catch(e){}
        bestTxt.textContent = `Best: ${best}`;
      }
      // show overlay
      overlayTitle.textContent = 'Game Over';
      overlayScore.textContent = `Score: ${score}`;
      overlayPanel.classList.remove('hidden');
      scoreDisplay.textContent = `Score: ${score}`;
    }

    // ---- Drawing helpers (long, explicit) ----
    function drawBackground(){
      if (bgImg.complete && bgImg.naturalWidth){
        ctx.drawImage(bgImg, 0, 0, W, H);
      } else {
        // fallback gradient sky
        const g = ctx.createLinearGradient(0,0,0,H);
        g.addColorStop(0,'#87CEEB'); g.addColorStop(1,'#bfefff');
        ctx.fillStyle = g;
        ctx.fillRect(0,0,W,H);
      }
    }

    function drawGround(){
      // ground base
      ctx.fillStyle = '#e0cf9a';
      ctx.fillRect(0, H - groundH, W, groundH);
      // grassy strip
      ctx.fillStyle = '#2e8b57';
      ctx.fillRect(0, H - groundH - 6, W, 6);
      // simple repeating pattern lines
      ctx.strokeStyle = 'rgba(0,0,0,0.04)';
      for(let i=0;i<W;i+=20){
        ctx.beginPath();
        ctx.moveTo(i, H - groundH + 4);
        ctx.lineTo(i+10, H - groundH + 4);
        ctx.stroke();
      }
    }

    function drawPipe(x, top){
      // top pipe body
      const headH = 24;
      ctx.save();
      // top gradient body
      const grad = ctx.createLinearGradient(0,0,0,top);
      grad.addColorStop(0,'#7fe37f'); grad.addColorStop(1,'#2b9c2b');
      ctx.fillStyle = grad;
      ctx.fillRect(x, 0, pipeW, top);

      // pipe head (rounded look)
      ctx.fillStyle = '#3aa43a';
      ctx.fillRect(x-6, top - headH/2, pipeW + 12, headH);
      ctx.restore();

      // bottom pipe
      const bottomTop = top + gap;
      const bottomH = H - groundH - bottomTop;
      const grad2 = ctx.createLinearGradient(0,bottomTop,0,bottomTop + bottomH);
      grad2.addColorStop(0,'#7fe37f'); grad2.addColorStop(1,'#2b9c2b');
      ctx.fillStyle = grad2;
      ctx.fillRect(x, bottomTop, pipeW, bottomH);
      // bottom head
      ctx.fillStyle = '#3aa43a';
      ctx.fillRect(x-6, bottomTop + bottomH - headH/2, pipeW + 12, headH);
    }

    function drawBird(){
      if (birdImg.complete && birdImg.naturalWidth){
        // rotate around center
        ctx.save();
        const cx = bird.x + bird.w/2;
        const cy = bird.y + bird.h/2;
        ctx.translate(cx, cy);
        ctx.rotate(bird.rotation);
        ctx.drawImage(birdImg, -bird.w/2, -bird.h/2, bird.w, bird.h);
        ctx.restore();
      } else {
        // fallback: simple yellow ellipse
        ctx.save();
        ctx.fillStyle = '#ffd54a';
        ctx.beginPath();
        ctx.ellipse(bird.x + bird.w/2, bird.y + bird.h/2, bird.w/2, bird.h/2, 0, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
      }
    }

    function drawHUD(){
      // left score already in topUI, but also draw shadowed text on canvas
      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.font = '22px "Segoe UI", Arial';
      ctx.textAlign = 'left';
      ctx.fillText(`Score: ${score}`, 12, 30);
      ctx.textAlign = 'right';
      ctx.fillText(`Best: ${best}`, W - 12, 30);
    }

    // ---- Main loop (explicit) ----
    function loop(){
      if (gameState !== 'running') return; // stop when paused/over/menu

      // physics
      bird.vy += bird.gravity;
      bird.y += bird.vy;

      // slight rotation smoothing
      bird.rotation += 0.06;
      if (bird.rotation > 1.2) bird.rotation = 1.2;

      // spawn management
      spawnTimer++;
      if (spawnTimer >= spawnInterval){
        spawnTimer = 0;
        spawnPipe();
      }

      // move pipes & check collisions & scoring
      for (let i = pipes.length - 1; i >= 0; i--){
        const p = pipes[i];
        p.x -= pipeSpeed;

        // scoring once when pipe passed
        if (!p.passed && p.x + pipeW < bird.x){
          p.passed = true;
          score++;
          playSound(sndPoint);
          scoreDisplay.textContent = `Score: ${score}`;
        }

        // collision?
        if (checkCollision(p)){
          hit();
          return;
        }

        // remove if off-screen
        if (p.x + pipeW < -100){
          pipes.splice(i,1);
        }
      }

      // ground collision
      if (bird.y + bird.h >= H - groundH){
        bird.y = H - groundH - bird.h;
        hit();
        return;
      }
      // ceiling clamp
      if (bird.y < 0){
        bird.y = 0;
        bird.vy = 0;
      }

      // DRAW: clear then draw everything in order
      ctx.clearRect(0,0,W,H);
      drawBackground();
      // pipes
      for (const p of pipes) drawPipe(p.x, p.top);
      drawGround();
      drawBird();
      drawHUD();

      // request next frame
      requestAnimationFrame(loop);
    }

    // ---- public helpers ----
    function start(){
      startGame();
    }
    function startGame(){
      // initialize values and start loop
      fitCanvas();
      pipes = [];
      score = 0;
      spawnTimer = 0;
      bird.y = Math.round(H*0.4);
      bird.vy = 0;
      bird.rotation = 0;
      gameState = 'running';
      scoreDisplay.textContent = `Score: ${score}`;
      overlayPanel.classList.add('hidden');
      menuPanel.style.display = 'none';
      // play bgm
      try{ bgm.currentTime = 0; playSound(bgm); }catch(e){}
      requestAnimationFrame(loop);
    }

    // expose restart to global used by buttons
    window.restart = function(){ startGame(); };
    window.backToMenu = function(){ backToMenu(); };

    // ---- initial draw (menu preview) ----
    function initialDraw(){
      // draw a simple menu preview on canvas so menu doesn't look empty
      fitCanvas();
      ctx.clearRect(0,0,W,H);
      drawBackground();
      drawGround();
      drawBird();
    }
    initialDraw();

    // ---- Start/pause/resume control bindings ----
    function resumeGame(){
      if (gameState !== 'paused') return;
      overlayPanel.classList.add('hidden');
      gameState = 'running';
      requestAnimationFrame(loop);
    }

    // ---- handle hit function already defined above ----

    // ---- UI wiring for overlay/menu buttons (additional) ----
    document.getElementById('resumeBtn').addEventListener('click', resumeGame);
    document.getElementById('restartBtn').addEventListener('click', function(){ startGame(); });
    document.getElementById('backMenu').addEventListener('click', function(){ backToMenu(); });

    function backToMenu(){
      // stop bgm & show menu
      try{ bgm.pause(); }catch(e){}
      gameState = 'menu';
      menuPanel.style.display = 'block';
      overlayPanel.classList.add('hidden');
    }

    // set level clicks
    lvlEasy.addEventListener('click', ()=>applyLevelSettings('easy'));
    lvlMed.addEventListener('click', ()=>applyLevelSettings('med'));
    lvlHard.addEventListener('click', ()=>applyLevelSettings('hard'));

    // ---- safe audio unlock already set earlier ----

    // ---- END of IIFE-like scope code ----
  })();
  </script>
</body>
  </html>
